name: Update GitHub Stats

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch stats and write JSON
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USER=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/users/Nakkshh")

          REPOS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/users/Nakkshh/repos?per_page=100")

          COMMITS=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.cloak-preview+json" \
            "https://api.github.com/search/commits?q=author:Nakkshh&per_page=1" \
            | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('total_count',0))")

          PUBLIC_REPOS=$(echo "$USER" | python3 -c \
            "import sys,json; print(json.load(sys.stdin).get('public_repos',0))")

          FOLLOWERS=$(echo "$USER" | python3 -c \
            "import sys,json; print(json.load(sys.stdin).get('followers',0))")

          STARS=$(echo "$REPOS" | python3 -c \
            "import sys,json; r=json.load(sys.stdin); print(sum(x.get('stargazers_count',0) for x in r) if isinstance(r,list) else 0)")

          python3 -c "
          import json
          data = {
            'commits': int('$COMMITS'),
            'repos': int('$PUBLIC_REPOS'),
            'stars': int('$STARS'),
            'followers': int('$FOLLOWERS'),
            'updated': '$(date -u +%Y-%m-%dT%H:%M:%SZ)'
          }
          with open('assets/stats.json', 'w') as f:
            json.dump(data, f, indent=2)
          print('Written:', data)
          "

      - name: Commit and push stats.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/stats.json
          git diff --staged --quiet || git commit -m "chore: update github stats [skip ci]"
          git push